# =============================================================================
# ComfyUI Docker Compose - Optimized for RTX 5090 (Blackwell)
# =============================================================================
# Build and push: ./build-push.sh  (uses docker-bake.hcl for versioning)
# Run only:       docker compose up -d
# =============================================================================

services:
  comfyui:
    # Use -latest tag (always points to newest build)
    # For rollback, change to specific version: comfyui-rtx5090-v1.0.0
    image: kairin/bases:comfyui-rtx5090-latest
    container_name: comfyui-rtx5090

    # Run as non-root user for security (matches Dockerfile UID/GID)
    user: "10001:10001"

    ports:
      - "8188:8188"

    # Environment variables for CUDA/GPU optimization
    environment:
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility,graphics
      - NVIDIA_VISIBLE_DEVICES=all
      - CUDA_DEVICE_ORDER=PCI_BUS_ID
      # PyTorch thread optimization for Ryzen 7 7700
      - TORCH_NUM_THREADS=16
      - OMP_NUM_THREADS=16
      - MKL_NUM_THREADS=16
      # Model cache directories
      - TORCH_HOME=/mnt/models_host/torch_cache
      - HF_HOME=/mnt/models_host/huggingface

    # Volume mounts for models and output
    volumes:
      - /srv/models:/mnt/models_host
      - /srv/output:/mnt/output_host

    # RTX 5090 optimizations for large shared memory and GPU access
    shm_size: 16gb
    ipc: host

    # Resource limits for pinned memory and file descriptors
    ulimits:
      memlock: -1
      stack: 67108864
      nofile: 65536

    # GPU allocation - RTX 5090 (single GPU)
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: ['0']
              capabilities: [gpu, compute, utility]

    # Restart policy
    restart: unless-stopped

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8188"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 120s

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"
